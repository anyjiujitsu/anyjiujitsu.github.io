<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ANY ‚Äî Admin</title>
  <style>
    :root{
      --bg:#e9e6df;
      --bar:#1f4f35;
      --bar2:#17402b;
      --card:#e6e6e6;
      --type:#efe1c8;
      --text:#111;
      --muted:#6b6b6b;
      --line: rgba(0,0,0,.12);
      --shadow: 0 10px 18px rgba(0,0,0,.12);
      --radius: 14px;
      --pill: 999px;
      --font: system-ui,-apple-system,Segoe UI,Roboto,Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Header: logo only */
    .top{
      padding: 16px 16px 10px 16px;
      display:flex;
      justify-content:center;
      align-items:center;
    }
    .anyLogo{
      width:72px;
      height:44px;
      display:block;
    }

    /* Green bar: Token + Save only */
    .bar{
      background: linear-gradient(180deg, var(--bar) 0%, var(--bar2) 100%);
      padding: 10px 12px;
      box-shadow: 0 6px 12px rgba(0,0,0,.20);
    }
    .controls{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      max-width: 980px;
      margin:0 auto;
      flex-wrap:wrap;
    }
    .pill{
      background: #fff;
      border: 1px solid rgba(0,0,0,.15);
      border-radius: var(--pill);
      height: 36px;
      display:flex;
      align-items:center;
      padding: 0 12px;
      gap:8px;
      box-shadow: 0 6px 10px rgba(0,0,0,.10);
      min-width: 260px;
    }
    .pill input{
      border:0;
      outline:none;
      background:transparent;
      width:100%;
      font-size:13px;
    }
    .pill button{
      border:0;
      background:transparent;
      font-size:12px;
      color:#333;
      cursor:pointer;
      padding:0 6px;
    }
    .btnPill{
      height:36px;
      border-radius: var(--pill);
      border: 1px solid rgba(0,0,0,.18);
      background:#fff;
      padding: 0 14px;
      font-size:13px;
      cursor:pointer;
      box-shadow: 0 6px 10px rgba(0,0,0,.10);
      display:flex;
      align-items:center;
      gap:8px;
      user-select:none;
      font-weight:700;
    }
    .btnPill:active{ transform: translateY(1px); }
    .btnPill[disabled]{opacity:.55; cursor:not-allowed}

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 14px 12px 28px 12px;
    }
    .sectionLabel{
      margin: 10px 6px 8px 6px;
      font-weight: 800;
      letter-spacing: 2px;
      color:#6a6a6a;
      font-size: 12px;
      text-transform: uppercase;
    }

    .card{
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      border:1px solid rgba(0,0,0,.06);
    }

    /* Full-width form (no left ADMIN column) */
    .content{
      padding: 12px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .field{
      display:grid;
      grid-template-columns: 88px 1fr;
      gap:10px;
      align-items:center;
    }
    .k{
      color:var(--muted);
      font-size:11px;
      font-weight: 800;
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    .v input, .v select{
      width:100%;
      height:36px;
      border-radius: 12px;
      border:1px solid rgba(0,0,0,.14);
      padding: 0 10px;
      background: rgba(255,255,255,.70);
      font-size: 13px;
      outline:none;
    }
    .v input:focus, .v select:focus{ box-shadow: 0 0 0 3px rgba(31,79,53,.18); }

    .v input[readonly]{
      background: rgba(255,255,255,.55);
      color:#2a2a2a;
    }

    /* Required marker */
    .req:after{
      content:" *";
      color:#b00020;
      font-weight:900;
      letter-spacing:0;
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      padding: 12px;
      border-top: 1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.25);
      justify-content: space-between;
    }
    .actions .btnPill{
      flex: 1 1 auto;
      justify-content:center;
      min-width: 140px;
    }

    .status{
      margin: 10px 6px 0 6px;
      font-size: 13px;
      font-weight: 800;
      color: #1f4f35;
    }
    .error{
      margin: 8px 6px 0 6px;
      font-size: 13px;
      font-weight: 800;
      color: #b00020;
      white-space: pre-wrap;
    }

    .hint{
      margin: 10px 6px 0 6px;
      font-size: 12px;
      color: var(--muted);
    }

    @media (max-width: 420px){
      .pill{ min-width: 240px; }
      .field{ grid-template-columns: 80px 1fr; }
    }
  </style>
</head>
<body>
  <div class="top" aria-label="ANY logo">
    <!-- Inline ANY logo (replace with your exact SVG if you want pixel-perfect) -->
    <svg class="anyLogo" viewBox="0 0 180 110" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="ANY">
      <rect x="10" y="10" width="160" height="90" rx="16" ry="16" fill="none" stroke="#1f4f35" stroke-width="8"/>
      <text x="90" y="74" text-anchor="middle" font-family="system-ui,-apple-system,Segoe UI,Roboto,Arial" font-weight="900" font-size="56" fill="#1f4f35">ANY</text>
    </svg>
  </div>

  <div class="bar">
    <div class="controls">
      <div class="pill" title="Paste token here (stored locally when you tap Save)">
        <span style="font-size:13px;opacity:.65">üîë</span>
        <input id="token" type="password" placeholder="GitHub token" />
        <button id="toggleToken" type="button" title="Show/Hide">üëÅ</button>
      </div>
      <button class="btnPill" id="saveTokenBtn" type="button">Save</button>
    </div>
  </div>

  <div class="wrap">
    <div class="sectionLabel">Add Event</div>

    <div class="card" aria-label="Add Event Form">
      <div class="content">
        <div class="field">
          <div class="k req">Event</div>
          <div class="v"><input id="f_EVENT" placeholder="Event name" required /></div>
        </div>

        <div class="field">
          <div class="k req">For</div>
          <div class="v">
            <select id="f_FOR" required>
              <option value="">Select‚Ä¶</option>
              <option>Seminar</option>
              <option>Comp</option>
              <option>Open Mat</option>
              <option>Women‚Äôs Open Mat</option>
              <option>Workshop / Clinic</option>
              <option>Camp</option>
              <option>In-House Tournament</option>
              <option>Superfight</option>
              <option>Fundraiser</option>
              <option>Party / Social</option>
              <option>Other</option>
            </select>
          </div>
        </div>

        <div class="field">
          <div class="k">Where</div>
          <div class="v"><input id="f_WHERE" placeholder="Gym / Address line" /></div>
        </div>

        <div class="field">
          <div class="k req">City</div>
          <div class="v"><input id="f_CITY" placeholder="City" required /></div>
        </div>

        <div class="field">
          <div class="k req">State</div>
          <div class="v">
            <select id="f_STATE" required>
              <option value="">Select‚Ä¶</option>
              <option>Massachusetts</option>
              <option>New Hampshire</option>
              <option>Maine</option>
              <option>Vermont</option>
              <option>Rhode Island</option>
              <option>Connecticut</option>
            </select>
          </div>
        </div>

        <div class="field">
          <div class="k">Date</div>
          <div class="v"><input id="f_DATE" type="date" /></div>
        </div>

        <div class="field">
          <div class="k req">Day</div>
          <div class="v"><input id="f_DAY" placeholder="Auto from date" readonly required /></div>
        </div>

        <div class="field">
          <div class="k">Created</div>
          <div class="v"><input id="f_CREATED" readonly /></div>
        </div>
      </div>

      <div class="actions">
        <button class="btnPill" id="appendBtn" type="button">Append + Commit</button>
        <button class="btnPill" id="clearFormBtn" type="button">Clear</button>
      </div>
    </div>

    <div class="hint">Required fields: Event, For, City, State, Day.</div>
    <div id="status" class="status"></div>
    <div id="error" class="error"></div>
  </div>

<script>
(() => {
  const OWNER  = "anyjiujitsu";
  const REPO   = "anyjiujitsu.github.io";
  const BRANCH = "main";
  const CSV_PATH = "data/events.csv";
  const CSV_COLUMNS = ["EVENT","FOR","WHERE","CITY","STATE","DAY","DATE","CREATED"];

  const $ = (id) => document.getElementById(id);
  const tokenEl = $("token");
  const statusEl = $("status");
  const errorEl = $("error");

  const btn = {
    save: $("saveTokenBtn"),
    append: $("appendBtn"),
    clearForm: $("clearFormBtn"),
  };

  function setBusy(b){
    Object.values(btn).forEach(x => x.disabled = !!b);
  }
  function setStatus(msg){ statusEl.textContent = msg || ""; errorEl.textContent = ""; }
  function setError(msg){ errorEl.textContent = msg || ""; statusEl.textContent = ""; }
  function clearError(){ errorEl.textContent = ""; }

  window.addEventListener("unhandledrejection", (e) => setError("Unhandled: " + (e.reason?.message || e.reason || "Unknown")));
  window.addEventListener("error", (e) => setError("Script error: " + (e.message || "Unknown")));

  // Token storage
  const LS_KEY = "anyne_events_admin_token";
  const saved = localStorage.getItem(LS_KEY);
  if (saved) tokenEl.value = saved;

  $("toggleToken").onclick = () => {
    tokenEl.type = (tokenEl.type === "password") ? "text" : "password";
  };

  btn.save.onclick = () => {
    const t = tokenEl.value.trim();
    if (!t) return setError("No token to save.");
    localStorage.setItem(LS_KEY, t);
    setStatus("Token saved locally.");
  };

  function requireToken(){
    const t = tokenEl.value.trim();
    if (!t) throw new Error("Missing token.");
    return t;
  }

  // CREATED: default to today dd/mm/yyyy, locked
  function pad2(n){ return String(n).padStart(2, "0"); }
  function setCreatedToday(){
    const d = new Date();
    const dd = pad2(d.getDate());
    const mm = pad2(d.getMonth() + 1);
    const yyyy = d.getFullYear();
    $("f_CREATED").value = `${dd}/${mm}/${yyyy}`;
  }
  setCreatedToday();

  // DAY derived from DATE (no manual override)
  function computeDay(yyyy_mm_dd){
    if (!yyyy_mm_dd) return "";
    const [y,m,d] = yyyy_mm_dd.split("-").map(Number);
    const dt = new Date(y, m-1, d);
    return dt.toLocaleDateString(undefined, { weekday:"long" });
  }
  $("f_DATE").addEventListener("change", (e) => {
    const day = computeDay(e.target.value);
    $("f_DAY").value = day || "";
  });

  // CSV escaping
  function csvEscape(v){
    if (v === null || v === undefined) return "";
    let s = String(v).trim().replace(/\r\n/g,"\n").replace(/\r/g,"\n");
    if (/[",\n]/.test(s)) s = '"' + s.replace(/"/g,'""') + '"';
    return s;
  }

  function makeRow(){
    // DATE stored as M/D/YYYY when date picked
    let dateOut = "";
    const dateVal = $("f_DATE").value;
    if (dateVal){
      const [y,m,d] = dateVal.split("-").map(Number);
      dateOut = `${m}/${d}/${y}`;
    }

    const map = {
      EVENT: $("f_EVENT").value,
      FOR: $("f_FOR").value,
      WHERE: $("f_WHERE").value,
      CITY: $("f_CITY").value,
      STATE: $("f_STATE").value,
      DAY: $("f_DAY").value,
      DATE: dateOut,
      CREATED: $("f_CREATED").value,
    };

    return CSV_COLUMNS.map(k => csvEscape(map[k] ?? "")).join(",");
  }

  function validateRequired(){
    const eventVal = $("f_EVENT").value.trim();
    const forVal = $("f_FOR").value.trim();
    const cityVal = $("f_CITY").value.trim();
    const stateVal = $("f_STATE").value.trim();
    const dayVal = $("f_DAY").value.trim();

    const missing = [];
    if (!eventVal) missing.push("Event");
    if (!forVal) missing.push("For");
    if (!cityVal) missing.push("City");
    if (!stateVal) missing.push("State");
    if (!dayVal) missing.push("Day (pick a Date)");

    if (missing.length){
      throw new Error("Missing required: " + missing.join(", "));
    }
  }

  btn.clearForm.onclick = () => {
    ["f_EVENT","f_WHERE","f_CITY"].forEach(id => $(id).value = "");
    $("f_FOR").value = "";
    $("f_STATE").value = "";
    $("f_DATE").value = "";
    $("f_DAY").value = "";
    setCreatedToday();
    setStatus("Form cleared.");
  };

  async function ghRequest(url, { method="GET", token="", body=null } = {}){
    const headers = { "Accept":"application/vnd.github+json" };
    if (token) headers["Authorization"] = "Bearer " + token;

    const res = await fetch(url, {
      method,
      headers: body ? { ...headers, "Content-Type":"application/json" } : headers,
      body: body ? JSON.stringify(body) : null
    });

    const text = await res.text();
    let json = null;
    try { json = text ? JSON.parse(text) : null; } catch {}

    if (!res.ok){
      const msg = json?.message || text || ("HTTP " + res.status);
      throw new Error(msg);
    }
    return json;
  }

  function b64DecodeUnicode(str){
    str = (str || "").replace(/\n/g,"");
    const bin = atob(str);
    const bytes = Uint8Array.from(bin, c => c.charCodeAt(0));
    return new TextDecoder("utf-8").decode(bytes);
  }
  function b64EncodeUnicode(str){
    const bytes = new TextEncoder().encode(str);
    let bin = "";
    bytes.forEach(b => bin += String.fromCharCode(b));
    return btoa(bin);
  }

  btn.append.onclick = async () => {
    clearError();
    setBusy(true);
    setStatus("Appending + committing‚Ä¶");

    try{
      validateRequired();
      const token = requireToken();
      const newRow = makeRow();

      // GET existing CSV + sha
      const getUrl = `https://api.github.com/repos/${encodeURIComponent(OWNER)}/${encodeURIComponent(REPO)}/contents/${CSV_PATH}?ref=${encodeURIComponent(BRANCH)}`;
      const data = await ghRequest(getUrl, { token });
      const csv = b64DecodeUnicode(data.content || "");
      const sha = data.sha;

      // Append
      let updated = csv;
      if (!updated.endsWith("\n")) updated += "\n";
      updated += newRow + "\n";

      // PUT updated file
      const putUrl = `https://api.github.com/repos/${encodeURIComponent(OWNER)}/${encodeURIComponent(REPO)}/contents/${CSV_PATH}`;
      const body = {
        message: `Append event row (${new Date().toISOString()})`,
        content: b64EncodeUnicode(updated),
        sha,
        branch: BRANCH
      };
      await ghRequest(putUrl, { method:"PUT", token, body });

      setStatus("‚úÖ Commit succeeded.");
    } catch(e){
      setError(e.message || String(e));
    } finally {
      setBusy(false);
    }
  };

  setStatus("Ready.");
})();
</script>
</body>
</html>
