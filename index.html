<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Gym Locator Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    :root {
      --bg: #020617;
      --bg-elevated: #020617;
      --panel: #020617;
      --accent: #4f8cff;
      --accent-soft: rgba(79, 140, 255, 0.1);
      --text: #e5e7eb;
      --text-soft: #9ca3af;
      --border-subtle: rgba(148, 163, 184, 0.25);
      --radius-xl: 22px;
      --radius-lg: 18px;
      --shadow-soft: 0 18px 45px rgba(0, 0, 0, 0.7);
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        sans-serif;
      background: radial-gradient(circle at top, #111827 0, var(--bg) 46%, #020617 100%);
      color: var(--text);
      display: flex;
      justify-content: center;
      padding: 24px 12px 40px;
    }

    @supports (padding: max(0px)) {
      body {
        padding-bottom: max(40px, env(safe-area-inset-bottom));
        padding-top: max(24px, env(safe-area-inset-top));
      }
    }

    .app-shell {
      width: 100%;
      max-width: 960px;
      background: radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.08), transparent 55%),
                  radial-gradient(circle at 100% 0, rgba(129, 140, 248, 0.09), transparent 50%),
                  radial-gradient(circle at 50% 120%, rgba(16, 185, 129, 0.18), transparent 60%),
                  rgba(15, 23, 42, 0.96);
      border-radius: 30px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: var(--shadow-soft);
      padding: 18px 18px 22px;
      position: relative;
      overflow: hidden;
    }

    .app-shell::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at 15% -10%, rgba(59, 130, 246, 0.25), transparent 55%),
        radial-gradient(circle at 110% 10%, rgba(236, 72, 153, 0.18), transparent 50%);
      opacity: 0.25;
      pointer-events: none;
    }

    .app-inner {
      position: relative;
      z-index: 1;
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 14px;
    }

    .eyebrow {
      font-size: 11px;
      letter-spacing: 0.17em;
      text-transform: uppercase;
      color: #9ca3af;
    }

    h1 {
      font-size: 22px;
      margin: 0;
      display: flex;
      gap: 6px;
      align-items: baseline;
    }

    h1 span.highlight {
      color: #93c5fd;
      font-weight: 650;
    }

    .subtitle {
      margin: 2px 0 0;
      font-size: 13px;
      color: var(--text-soft);
    }

    .search-panel {
      margin-top: 12px;
      background: radial-gradient(circle at 0% 0%, rgba(15, 23, 42, 0.5), transparent 60%),
                  rgba(15, 23, 42, 0.96);
      border-radius: 18px;
      border: 1px solid var(--border-subtle);
      padding: 10px 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .search-input-wrap {
      flex: 1 1 210px;
      position: relative;
    }

    .search-input-wrap input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.96);
      padding: 9px 34px 9px 30px;
      color: var(--text);
      font-size: 13px;
      outline: none;
    }

    .search-input-wrap input::placeholder {
      color: #64748b;
    }

    .search-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 14px;
      opacity: 0.85;
    }

    .clear-btn {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      border-radius: 999px;
      padding: 2px 6px;
      font-size: 10px;
      background: rgba(148, 163, 184, 0.2);
      color: #e5e7eb;
      cursor: pointer;
      display: none;
    }

    .clear-btn.visible {
      display: inline-flex;
    }

    .search-panel button.locate-btn {
      border-radius: 999px;
      border: none;
      padding: 9px 14px;
      font-size: 12px;
      font-weight: 500;
      background: linear-gradient(135deg, #4f46e5, #22c55e);
      color: white;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      white-space: nowrap;
    }

    .search-panel button.locate-btn span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 5px rgba(34, 197, 94, 0.25);
    }

    .search-meta {
      font-size: 11px;
      color: var(--text-soft);
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .radius-pill {
      border-radius: 999px;
      padding: 4px 9px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(148, 163, 184, 0.6);
      font-size: 11px;
    }

    #map {
      height: 320px;
      border-radius: 22px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      margin-top: 14px;
      overflow: hidden;
    }

    .leaflet-container {
      background: #020617;
    }

    .results-panel {
      margin-top: 14px;
      background: rgba(15, 23, 42, 0.96);
      border-radius: 20px;
      border: 1px solid var(--border-subtle);
      padding: 12px 12px 10px;
      max-height: 360px;
      overflow-y: auto;
      scroll-behavior: smooth;
    }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 6px;
    }

    .results-title {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #cbd5f5;
    }

    .results-count {
      font-size: 11px;
      color: #9ca3af;
    }

    .list {
      list-style: none;
      margin: 6px 0 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .card {
      border-radius: 14px;
      padding: 8px 10px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: radial-gradient(circle at 0 0, rgba(59, 130, 246, 0.2), transparent 55%),
                  rgba(15, 23, 42, 0.96);
      display: flex;
      flex-direction: column;
      gap: 2px;
      cursor: pointer;
    }

    .card-header-line {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
    }

    .card-title {
      font-size: 13px;
      font-weight: 600;
    }

    .card-distance {
      font-size: 11px;
      color: #a5b4fc;
      white-space: nowrap;
    }

    .card-location {
      font-size: 12px;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .card-location .geo-pin {
      font-size: 13px;
    }

    .card-meta {
      font-size: 11px;
      color: #9ca3af;
    }

    .empty-state {
      font-size: 12px;
      color: #9ca3af;
      padding: 4px 0 2px;
    }

    @media (max-width: 768px) {
      body {
        padding: 16px 10px 32px;
      }

      .app-shell {
        padding: 14px 14px 18px;
        border-radius: 24px;
      }

      #map {
        height: 260px;
      }

      .results-panel {
        max-height: 320px;
      }
    }

    @media (max-width: 480px) {
      .search-panel {
        flex-direction: column;
        align-items: stretch;
      }

      .search-panel button.locate-btn {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <div class="app-inner">
      <header>
        <div class="eyebrow">ANY ‚Ä¢ NE GRAPPLING</div>
        <h1>
          <span>Academy</span>
          <span class="highlight">Map</span>
        </h1>
        <p class="subtitle">Search a location to see jiu-jitsu gyms within a 20 mile radius.</p>
      </header>

      <section class="search-panel">
        <div class="search-input-wrap">
          <span class="search-icon">üîç</span>
          <input
            id="searchInput"
            type="text"
            placeholder="Enter a town, city, or address‚Ä¶"
          />
          <button id="clearSearch" class="clear-btn">Clear</button>
        </div>
        <button class="locate-btn" id="useMyLocationBtn" type="button">
          <span class="dot"></span>
          Use my location
        </button>
        <div class="search-meta">
          <span class="radius-pill">Radius: 20 miles</span>
        </div>
      </section>

      <div id="map"></div>

      <section class="results-panel" aria-label="Gyms within 20 miles">
        <div class="results-header">
          <div class="results-title">Gyms in range</div>
          <div class="results-count"><span id="resultsCount">0</span> found</div>
        </div>
        <div id="resultsContainer" class="empty-state">
          Enter a location above to see nearby gyms.
        </div>
      </section>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // --- Sample gym data: replace / extend this array with real academies ---
    const gyms = [
      {
        id: 1,
        name: "Black Hole Jiu-Jitsu",
        city: "Seymour",
        state: "Connecticut",
        lat: 41.396,
        lng: -73.089,
      },
      {
        id: 2,
        name: "Lauzon MMA",
        city: "Canton",
        state: "Massachusetts",
        lat: 42.156,
        lng: -71.144,
      },
      {
        id: 3,
        name: "Broadway Jiu-Jitsu",
        city: "South Boston",
        state: "Massachusetts",
        lat: 42.3334,
        lng: -71.0507,
      },
      {
        id: 4,
        name: "Fenway BJJ",
        city: "Boston",
        state: "Massachusetts",
        lat: 42.3459,
        lng: -71.0983,
      },
      {
        id: 5,
        name: "Nostos MMA",
        city: "Somersworth",
        state: "New Hampshire",
        lat: 43.2597,
        lng: -70.8653,
      }
    ];

    const RADIUS_MILES = 20;
    const RADIUS_KM = RADIUS_MILES * 1.60934;

    // --- Map setup ---
    const map = L.map("map", {
      zoomControl: false,
    }).setView([42.3601, -71.0589], 8); // default: Boston

    L.control.zoom({ position: "bottomright" }).addTo(map);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>',
      maxZoom: 19,
    }).addTo(map);

    let userMarker = null;
    const gymMarkers = [];

    function haversineDistance(lat1, lon1, lat2, lon2) {
      const toRad = (v) => (v * Math.PI) / 180;
      const R = 6371; // km
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRad(lat1)) *
          Math.cos(toRad(lat2)) *
          Math.sin(dLon / 2) *
          Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c; // km
    }

    function clearGymMarkers() {
      gymMarkers.forEach((m) => map.removeLayer(m));
      gymMarkers.length = 0;
    }

    function renderResults(centerLat, centerLng) {
      clearGymMarkers();

      const nearby = gyms
        .map((g) => {
          const distanceKm = haversineDistance(centerLat, centerLng, g.lat, g.lng);
          const distanceMiles = distanceKm / 1.60934;
          return { ...g, distanceKm, distanceMiles };
        })
        .filter((g) => g.distanceKm <= RADIUS_KM)
        .sort((a, b) => a.distanceKm - b.distanceKm);

      const resultsContainer = document.getElementById("resultsContainer");
      const countEl = document.getElementById("resultsCount");

      if (!nearby.length) {
        resultsContainer.className = "empty-state";
        resultsContainer.textContent =
          "No gyms found within 20 miles of this point. Try another location.";
        countEl.textContent = "0";
        return;
      }

      countEl.textContent = nearby.length.toString();

      const list = document.createElement("ul");
      list.className = "list";

      const bounds = [];

      nearby.forEach((g) => {
        // Add marker
        const marker = L.marker([g.lat, g.lng]).addTo(map);
        marker.bindPopup(
          `<strong>${g.name}</strong><br />${g.city}, ${g.state}<br /><small>${g.distanceMiles.toFixed(
            1
          )} mi away</small>`
        );
        gymMarkers.push(marker);
        bounds.push([g.lat, g.lng]);

        // Card
        const li = document.createElement("li");
        li.className = "card";
        li.dataset.gymId = g.id;

        const headerLine = document.createElement("div");
        headerLine.className = "card-header-line";

        const title = document.createElement("div");
        title.className = "card-title";
        title.textContent = g.name;

        const distance = document.createElement("div");
        distance.className = "card-distance";
        distance.textContent = `${g.distanceMiles.toFixed(1)} mi`;

        headerLine.appendChild(title);
        headerLine.appendChild(distance);

        const locationRow = document.createElement("div");
        locationRow.className = "card-location";
        const pin = document.createElement("span");
        pin.className = "geo-pin";
        pin.textContent = "üìç";
        const locText = document.createElement("span");
        locText.textContent = `${g.city}, ${g.state}`;
        locationRow.appendChild(pin);
        locationRow.appendChild(locText);

        const meta = document.createElement("div");
        meta.className = "card-meta";
        meta.textContent = "Click to focus on map";

        li.appendChild(headerLine);
        li.appendChild(locationRow);
        li.appendChild(meta);

        li.addEventListener("click", () => {
          map.setView([g.lat, g.lng], 12);
          marker.openPopup();
        });

        list.appendChild(li);
      });

      resultsContainer.className = "";
      resultsContainer.innerHTML = "";
      resultsContainer.appendChild(list);

      if (bounds.length) {
        const group = new L.LatLngBounds(bounds);
        group.extend([centerLat, centerLng]);
        map.fitBounds(group, { padding: [40, 40] });
      }
    }

    async function geocode(query) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
        query
      )}`;
      const res = await fetch(url, {
        headers: {
          "Accept-Language": "en",
        },
      });
      if (!res.ok) {
        throw new Error("Geocoding failed");
      }
      const data = await res.json();
      if (!data.length) {
        throw new Error("No results");
      }
      const best = data[0];
      return {
        lat: parseFloat(best.lat),
        lng: parseFloat(best.lon),
        label: best.display_name,
      };
    }

    function setUserMarker(lat, lng) {
      if (userMarker) {
        userMarker.setLatLng([lat, lng]);
      } else {
        userMarker = L.circleMarker([lat, lng], {
          radius: 7,
          color: "#22c55e",
          weight: 2,
          fillColor: "#22c55e",
          fillOpacity: 0.5,
        }).addTo(map);
      }
    }

    async function handleSearch(query) {
      const resultsContainer = document.getElementById("resultsContainer");
      const countEl = document.getElementById("resultsCount");
      try {
        resultsContainer.className = "empty-state";
        resultsContainer.textContent = "Searching‚Ä¶";
        countEl.textContent = "0";

        const loc = await geocode(query);
        setUserMarker(loc.lat, loc.lng);
        renderResults(loc.lat, loc.lng);
      } catch (err) {
        console.error(err);
        clearGymMarkers();
        if (userMarker) {
          map.removeLayer(userMarker);
          userMarker = null;
        }
        resultsContainer.className = "empty-state";
        resultsContainer.textContent =
          "Could not find that location. Try another city or a more specific address.";
        document.getElementById("resultsCount").textContent = "0";
      }
    }

    // --- Event wiring ---
    const searchInput = document.getElementById("searchInput");
    const clearSearchBtn = document.getElementById("clearSearch");

    searchInput.addEventListener("input", () => {
      clearSearchBtn.classList.toggle("visible", searchInput.value.trim().length > 0);
    });

    searchInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        const query = searchInput.value.trim();
        if (query) {
          handleSearch(query);
        }
      }
    });

    clearSearchBtn.addEventListener("click", () => {
      searchInput.value = "";
      clearSearchBtn.classList.remove("visible");
      clearGymMarkers();
      if (userMarker) {
        map.removeLayer(userMarker);
        userMarker = null;
      }
      document.getElementById("resultsContainer").className = "empty-state";
      document.getElementById("resultsContainer").textContent =
        "Enter a location above to see nearby gyms.";
      document.getElementById("resultsCount").textContent = "0";
      map.setView([42.3601, -71.0589], 8);
    });

    document
      .getElementById("useMyLocationBtn")
      .addEventListener("click", () => {
        if (!navigator.geolocation) {
          alert("Geolocation is not supported by your browser.");
          return;
        }
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const { latitude, longitude } = pos.coords;
            setUserMarker(latitude, longitude);
            renderResults(latitude, longitude);
          },
          (err) => {
            console.error(err);
            alert("Unable to access your location.");
          }
        );
      });
  </script>
</body>
</html>
